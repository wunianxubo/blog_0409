---
title: Java中的线程池  
date: 2017-08-30 15:57:00  
tags: [java,java并发]    
categories: java  
---
# 线程池的好处
**1、降低资源消耗**  
通过重复利用已创建的线程降低线程创建和销毁造成的消耗。  
**2、提高响应速度**  
当任务到达时，任务可以不需要等到线程创建就能立即执行。  
**3、提高线程的可管理性**  
线程是稀缺资源，如果无限制的创建，不仅会消耗系统资源，还会降低系统的稳定性，使用线程池可以进行统一分配、调优和监控。  

# 一、线程池的实现原理
![image](http://osrmzp0jr.bkt.clouddn.com/%E5%89%AF%E6%9C%AC1.jpg)  
**ThreadPoolExecutor执行execute()方法步骤：**  
1、如果当前运行的线程少于corePoolSize，那么创建新的线程来执行任务  
2、如果运行的线程等于或者多于corePoolSize，那么将任务加入BlockingQueue  
3、如果BlockingQueue中任务已满，并且当前运行的线程数少于maximumPoolSize，那么创建新的线程来处理任务  
4、如果当前运行的线程数多于maximumPoolSize，任务将被拒绝，并调用RejectedExecutionHandler.rejectdExecution()方法（饱和策略）  
![image](http://osrmzp0jr.bkt.clouddn.com/1_%E5%89%AF%E6%9C%AC.jpg)  
**线程池中的线程执行任务分两种情况：**  
1、在execute()方法中创建一个线程时，会让这个线程执行当前任务  
2、这个线程执行完图中1的任务后，会反复从BlockingQueue中获取任务来执行  

# 二、线程池的使用
## 1、线程池的创建
new ThreadPoolExecutor(corePoolSize, runnableTaskQueue, maximumPoolSize, handler, keepAliveTime);  
**①corePoolSize（线程池的核心线程数）**：当提交一个任务到线程池时，线程池会创建一个线程来执行任务，即使其他空闲的基本线程能够执行新任务也会创建新线程，等到需要执行的任务数大于线程池的核心线程数时就不再创建。具体可以参考上图  
**②runnableTaskQueue（任务队列）**：用于保存等待执行的任务的阻塞队列。有以下几个阻塞队列：  
&emsp;1、ArrayBlockingQueue：是一个基于数组结构的**有界阻塞队列**，按先进先出原则对元素进行排序。  
&emsp;2、LinkedBlockingQueue：一个基于链表结构的**无界阻塞队列**，吞吐量高于有界队列，newFixedThreadPool采用这个队列。    
&emsp;3、SynchronousQueue：不存储元素的阻塞队列。每个插入操作必须等到另一个线程调用移除操作，否则插入操作一直处于阻塞状态，newCachedThreadPool使用这个队列。  
&emsp;4、PriporityBlockingQueue：一个具有优先级的**无界阻塞队列**。  
**③maximumPoolSize（线程池最大数量）**：线程池允许创建线程的最大数量。如果队列满了，且创建的线程数小于最大线程数，那么线程池会创建新的线程执行任务。  
**④handler（饱和策略）**：当队列和线程池都满了，说明线程池处于饱和状态，采取饱和策略处理提交的任务。有四种策略：  
&emsp;1、AbortPolicy：终止策略，直接抛出异常（默认采用）  
&emsp;2、CallerRunsPolicy：调用者运行策略，将某些任务回退给调用者，来降低新任务的流量  
&emsp;3、DiscardOldestPolicy：抛弃策略，丢弃队列里最近的一个任务，并执行当前任务  
&emsp;4、DiscardPolicy：抛弃最旧的策略，不处理，丢弃掉  
**⑤keepAliveTime（线程活动保持的时间）**：线程池的工作线程空闲后，保持存活的时间。  
## 2、线程池的关闭  
可以通过shutdown或者shutdownNow方法来关闭线程池。原理是遍历线程池中的工作线程，然后逐个调用线程的interrupt方法来中断线程。但也存在一些区别：  
shutdownNow：首先将线程池的状态设置为STOP，然后尝试**停止所有正在执行或暂停任务的线程，并返回等待执行任务的列表**。  
shutdown：将线程池的状态设置为SHUTDOWN状态，然后**中断所有没有正在执行任务的线程**。  
## 3、合理配置线程池
从下面几个角度分析：  
1、任务的性质：CPU密集型任务、IO密集型任务和混合型任务。  
2、任务的优先级：高、中、低  
3、任务的执行时间：长、中、短  
4、任务的依赖性：是否依赖其他系统资源，比如数据库连接  
如果**任务是CPU密集型的，应配置尽可能少的线程**，如等于可用的处理器核数，这样就可以充分利用处理器，让它以最大火力不停进行计算。创建更多的线程反而是不利的，因为多个线程频繁进行上下文切换对性能消耗太大。  
如果**任务是IO密集型的，应尽可能配置多的线程**，如处理器核数的几倍。因为在执行IO操作时，线程将被阻塞，此时处理器可以立即进行上下文切换以便其他线程开始任务。如果线程数不够，那么有待执行的任务也无法调度处理了。  
可以使用公式计算出程序所需线程数：**线程数=CPU可用核心数/(1-阻塞系数)**，其中阻塞系数在0到1范围内。CPU密集型的阻塞系数为0，IO密集型的阻塞系数接近1。  
# 三、线程池的本质
**线程池的本质是使用了一个线程安全的工作队列连接工作者线程和客户端线程，客户端线程将任务放入工作队列后便返回，而工作者线程则不断地从工作队列上取出工作并执行，典型的生产者-消费者模型。**

