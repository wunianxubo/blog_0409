---
title: 谈谈分布式事务
date: 2018-04-16 22:17:00  
tags: [大型网站技术架构,分布式]    
categories: 分布式系统
---
## 什么是分布式事务
一个事务由多个不同的小操作组成，这些小的操作分布在不同的服务器上，且属于不同的应用，分布式事务需要确保这些小的操作要么全部成功，要么全部失败。从本质上说，分布式事务是为了保证不同数据库之间的一致性。分布式事务的应用场景主要是在支付和在线下单，支付涉及到扣款和加钱，而在线下单则涉及到扣库存和更新账单，需要分布式事务来保证一致性。    

<!-- more -->

## 分布式事务产生的原因
### 数据库的分库分表
分库分表后，原来的一个数据库分为了多个数据库，如果一个操作既要更新库01，又要更新库02，而且要保证数据的一致性，那么就需要用到分布式事务。  

![image](http://osrmzp0jr.bkt.clouddn.com/shiwu1.png)  

### 应用SOA化
即业务的服务化。以前单机支撑了整个电商网站，现在对整个网站进行拆解，分离出了订单中心，用户中心，库存中心等，对于每个中心有专门的数据库进行信息的存储。如果同时涉及到对订单和库存的操作，那么为了保证数据的一致性，需要用到分布式事务。  

![image](http://osrmzp0jr.bkt.clouddn.com/shiwu2.png)  

## 事务的ACID特性
- 原子性  
在整个事务中的所有操作，要么全部完成，要么全部不做，没有中间状态。对于事务在执行中发生错误，所有的操作都会被回滚，整个事务就像从没被执行过一样。
- 一致性  
事务的执行必须保证系统的一致性，就拿转账为例，A有500元，B有300元，如果在一个事务里A成功转给B50元，那么不管并发多少，不管发生什么，只要事务执行成功了，那么最后A账户一定是450元，B账户一定是350元。
- 隔离性  
所谓的隔离性就是说，事务与事务之间不会互相影响，一个事务的中间状态不会被其他事务感知。
- 持久性  
持久性，就是说一单事务完成了，那么事务对数据所做的变更就完全保存在了数据库中，即使发生停电，系统宕机也是如此。  

## 一致性理论
### CAP理论
在分布式系统中，一致性（Consistency）、可用性（Availabilty）和分区容忍性（Partition Tolerance）三个要素最多只能同时满足两个，不可兼得，而对于分布式系统，分区容忍性是不可或缺的。  

![image](http://osrmzp0jr.bkt.clouddn.com/cap.png)

- 一致性：分布式环境下多个节点的数据是否强一致。  
- 可用性：分布式服务能一直保证可用状态。当用户发出一个请求后，服务能在有限时间内返回结果。  
- 分区容忍性：特指对网络分区的容忍性。  

### BASE理论
- 基本可用（Basically Available）：指分布式系统在出现故障时，允许损失部分的可用性来保证核心可用。
- 软状态（Soft State）：指允许分布式系统存在中间状态，该中间状态不会影响到系统的整体可用性。
- 最终一致性（Eventual Consistency）：指分布式系统中的所有副本数据经过一定时间后，最终能够达到一致的状态

## 一致性模型
- 强一致性：数据更新成功后，任意时刻所有副本中的数据都是一致的，一般采用同步的方式实现。
- 弱一致性：数据更新成功后，系统不承诺立即可以读到最新写入的值，也不承诺具体多久之后可以读到。
- 最终一致性：弱一致性的一种形式，数据更新成功后，系统不承诺立即可以返回最新写入的值，但是保证最终会返回上一次更新操作的值。


## 常见的分布式事务解决方案
### 1、基于XA协议的两阶段提交（2PC）
XA协议分为两部分：事务管理器和本地资源管理器，本地资源管理器主要由数据库实现，而事务管理器作为全局的调度者，负责各个本地资源的提交和回滚。  

![image](http://osrmzp0jr.bkt.clouddn.com/2pc%20tb.jpg)  

这种方式实现难度不算高，比较适合传统的单体应用，在同一个方法中存在跨库操作的情况，能保证强一致性。但对性能的影响比较大，不适合高并发和高性能要求的场景。  

### 2、消息事务 - 最终一致性  
消息事务是基于消息中间件的两阶段提交，将本地事务和发消息放在了一个分布式事务里，保证要么本地操作成功并且对外发消息成功，要么两个操作都失败。  

基于消息中间件的两阶段提交往往用在高并发场景下，将一个分布式事务拆分成一个消息事务（A系统的本地操作+发消息）+B系统的本地操作。其中B系统的操作由消息驱动，只要消息事务成功，那么A操作一定成功，消息也一定发出来了，之后B会受到消息去执行本地操作，如果本地操作失败，消息会重投，知道B操作成功，这样就变相的完成了A与B的分布式事务。  

![image](http://osrmzp0jr.bkt.clouddn.com/message%20tx.png)  

### 3、事务补偿型（TCC事务）
在一个长事务中，由两台服务器一起参与，服务器A发起事务，服务器B参与事务。如果服务器A的事务执行顺利，那么事务A先行提交，如果事务B也执行顺利，则事务B也提交，整个事务完成。如果事务B执行失败，事务B本身回滚，这时事务A已经被提交，所以需要执行一个补偿操作，将已经提交的事务A执行的操作作反操作，恢复到未执行事务A的状态。  

![image](http://osrmzp0jr.bkt.clouddn.com/tcc.jpg)  

![image](http://osrmzp0jr.bkt.clouddn.com/tcc2.jpg)  

参考文章：  
分布式事务的典型处理方式 https://blog.csdn.net/mine_song/article/details/64118963  
大规模SOA系统中的分布事务处理  https://wenku.baidu.com/view/be946bec0975f46527d3e104.html